<!DOCTYPE html>
<html lang="lt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stalo Å¾aidimÅ³ vakaras â€” registracija</title>

  <style>
    :root{
      --bg0:#071327;
      --bg1:#0a1731;
      --card:#0f1e3a;
      --card2:#0d1a33;
      --border:#223257;
      --text:#e9eef7;
      --muted:#a8b4c8;
      --muted2:#7f8aa1;
      --pill:#15264a;
      --pill2:#0f2144;
      --accent:#5aa8ff;
      --accent2:#2e6dff;
      --danger:#ff5b5b;
      --shadow: 0 24px 60px rgba(0,0,0,.35);
      --r:14px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color:var(--text);
      background: radial-gradient(900px 520px at 20% 10%, #102a5c 0%, rgba(16,42,92,0) 55%),
                  linear-gradient(180deg,var(--bg0),var(--bg1));
      padding:18px 18px 28px;
    }
    .wrap{max-width:980px;margin:0 auto}

    .card{
      background: linear-gradient(180deg, var(--card), var(--card2));
      border:1px solid var(--border);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding:16px 16px;
      margin-bottom:14px;
    }

    h1,h2,h3{margin:0}
    h1{font-size:18px;font-weight:700;margin-bottom:8px}
    h2{font-size:16px;font-weight:700;margin-bottom:8px}
    h3{font-size:14px;font-weight:700;margin-bottom:8px}

    .muted{color:var(--muted);font-size:12px;line-height:1.35}
    .muted2{color:var(--muted2);font-size:12px;line-height:1.35}

    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .space{justify-content:space-between}
    .stack{display:flex;flex-direction:column;gap:4px}

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: linear-gradient(180deg, var(--pill), var(--pill2));
      color:var(--text);
      font-size:12px;
      user-select:none;
      white-space:nowrap;
    }

    .btn{
      border:1px solid var(--border);
      background: linear-gradient(180deg, #1a2d55, #13264a);
      color:var(--text);
      padding:8px 12px;
      border-radius:10px;
      font-size:12px;
      cursor:pointer;
      transition:transform .04s ease;
    }
    .btn:active{transform:translateY(1px)}
    .btn.primary{
      border-color: rgba(90,168,255,.55);
      background: linear-gradient(180deg, rgba(90,168,255,.25), rgba(46,109,255,.22));
    }
    .btn.danger{
      border-color: rgba(255,91,91,.55);
      color: #ffd6d6;
      background: linear-gradient(180deg, rgba(255,91,91,.14), rgba(255,91,91,.08));
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    @media (max-width: 860px){
      .grid2{grid-template-columns:1fr}
    }

    label{display:block;font-size:12px;font-weight:650;margin:10px 0 6px}
    .subLabel{display:block;font-size:11px;color:var(--muted2);font-weight:500;margin-top:2px}

    input, select, textarea{
      width:100%;
      border-radius:10px;
      border:1px solid var(--border);
      background: rgba(7,19,39,.55);
      color:var(--text);
      padding:10px 11px;
      font-size:12px;
      outline:none;
    }
    textarea{resize:vertical;min-height:74px}

    .status{margin-top:10px;font-size:12px}
    .status.ok{color:#88ff9b}
    .status.warn{color:#ffd27a}

    .gameList{margin-top:10px}
    .gameItem{
      margin-top:10px;
      padding-top:10px;
      border-top:1px solid var(--border);
    }
    .gameTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    .gameTitle{font-weight:700;font-size:13px}
    .gameMeta{color:var(--muted);font-size:11.5px;margin-top:2px;line-height:1.25}
    .gameDesc{color:var(--muted2);font-size:11.5px;margin-top:6px;line-height:1.25}

    .votes{display:flex;align-items:center;gap:6px}
    .voteBtn{
      width:28px;height:28px;
      border-radius:8px;
      border:1px solid var(--border);
      background: rgba(7,19,39,.45);
      color:var(--text);
      cursor:pointer;
    }
    .score{min-width:20px;text-align:center;font-size:12px;color:var(--text)}
    .adminOnly{display:none}
    .adminOn .adminOnly{display:block}

    a.fakeLink{color:var(--accent);text-decoration:none}
    a.fakeLink:hover{text-decoration:underline}
  </style>
</head>

<body>
<div class="wrap">

  <!-- TOP CARD -->
  <div class="card">
    <div class="row space">
      <h1>Stalo Å¾aidimÅ³ vakaras â€” registracija</h1>

      <div class="row">
        <button id="jumpRegBtn" class="btn primary" type="button">UÅ¾siregistruoti</button>
        <span id="datePill" class="pill">â€”</span>
      </div>
    </div>

    <div class="stack" style="margin-top:8px;">
      <div id="eventLine" class="muted">Renginio data: â€”</div>
      <div id="eventLineEn" class="muted2">Event date: â€”</div>

      <div id="notesLine" class="muted" style="margin-top:4px;"></div>
      <div id="notesLineEn" class="muted2"></div>

      <div class="muted" style="margin-top:10px;">UÅ¾siregistravÄ™:</div>
      <div class="muted2">Registered:</div>

      <div id="whoList" class="muted" style="margin-top:4px;">â€”</div>
      <div class="muted" style="margin-top:8px;">
        Dalyvavimas nebÅ«tinas, bet reikalinga registracija
      </div>
      <div class="muted2">
        Participation optional, but registration is required.
      </div>
    </div>
  </div>

  <!-- SUGGESTIONS + VOTING CARD -->
  <div class="card">
    <div class="row space">
      <div>
        <h2>Å½aidimÅ³ pasiÅ«lymai ir balsavimas</h2>
        <div class="muted">PasiÅ«lyk Å¾aidimÄ… ir balsuok, kÄ… Å¾aisime.</div>
        <div class="muted2">Suggest a game and vote what weâ€™ll play.</div>
      </div>

      <div class="row">
        <button id="jumpSuggestBtn" class="btn primary" type="button">0 pasiÅ«lymÅ³</button>
        <span class="pill">rÅ«Å¡iuojama pagal balsus</span>
      </div>
    </div>

    <div id="gameList" class="gameList">
      <div class="muted" style="margin-top:8px;">Kol kas nÄ—ra pasiÅ«lymÅ³ â€” pridÄ—k savo ğŸ™‚</div>
      <div class="muted2">No suggestions yet â€” add one ğŸ™‚</div>
    </div>

    <div class="muted" style="margin-top:12px;">
      SudÄ—tingumas: jei taisyklÄ—s turi puslapiÅ³ skaiÄius daugiau nei 10, tai yra sudÄ—tingas Å¾aidimas
    </div>
    <div class="muted2">
      Complexity: if the rulebook has more than 10 pages, the game is considered complex.
    </div>
  </div>

  <!-- TWO COLUMN: REG + SUGGEST -->
  <div class="grid2">

    <!-- REGISTRATION CARD -->
    <div class="card" id="regCard">
      <h2>Registracija</h2>
      <div class="muted2">Registration</div>

      <form id="regForm" style="margin-top:8px;">
        <label for="name">Vardas, pavardÄ— <span class="subLabel">Name</span></label>
        <input id="name" autocomplete="name" placeholder="Pvz., Audrius PreikÅ¡as" required />

        <button class="btn primary" style="margin-top:10px;" type="submit">
          UÅ¾siregistruoti
          <span class="muted2" style="margin-left:8px;">Register</span>
        </button>

        <div class="muted2" style="margin-top:10px;">
          Registruojiesi datai virÅ¡uje
        </div>
        <div class="muted2">
          Youâ€™re registering for the date shown above
        </div>

        <div id="regStatus" class="status"></div>
      </form>
    </div>

    <!-- SUGGESTION CARD -->
    <div class="card" id="suggestCard">
      <h2>SiÅ«lyti stalo Å¾aidimÄ…</h2>
      <div class="muted2">Suggest a board game</div>

      <form id="gameForm" style="margin-top:8px;">
        <label for="gTitle">Å½aidimo pavadinimas <span class="subLabel">Game title</span></label>
        <input id="gTitle" placeholder="Pvz., Codenames" />

        <div class="grid2" style="gap:10px;">
          <div>
            <label for="gDifficulty">SudÄ—tingumas (1/2/3) <span class="subLabel">Complexity (1/2/3)</span></label>
            <select id="gDifficulty">
              <option value="">Pasirinktiâ€¦</option>
              <option value="1">1 â€” Lengvas / Easy</option>
              <option value="2">2 â€” Vidutinis / Medium</option>
              <option value="3">3 â€” Sunkesnis / Harder</option>
            </select>
          </div>

          <div>
            <label for="gHost">Reikalingas vedÄ—jas <span class="subLabel">Needs a host (Yes/No)</span></label>
            <select id="gHost">
              <option value="">Pasirinktiâ€¦</option>
              <option value="Taip / Yes">Taip / Yes</option>
              <option value="Ne / No">Ne / No</option>
            </select>
          </div>
        </div>

        <div class="grid2" style="gap:10px;">
          <div>
            <label for="gPlayers">Å½aidÄ—jÅ³ skaiÄius be vedÄ—jo* <span class="subLabel">Player count without a host*</span></label>
            <input id="gPlayers" placeholder="Pvz., 2â€“6" />
          </div>

          <div>
            <label for="gType">Å½aidimo tipas (co-op / comp) <span class="subLabel">Type (co-op / competitive)</span></label>
            <select id="gType">
              <option value="">Pasirinktiâ€¦</option>
              <option value="Co-op">Co-op</option>
              <option value="Competitive">Competitive</option>
              <option value="Party">Party</option>
              <option value="Strategy">Strategy</option>
            </select>
          </div>
        </div>

        <label for="gDesc">Trumpas apraÅ¡ymas <span class="subLabel">Short description</span></label>
        <textarea id="gDesc" placeholder="1â€“2 sakiniai: kuo smagus, kiek trunka, ar lengva iÅ¡moktiâ€¦"></textarea>

        <button class="btn primary" style="margin-top:10px;" type="submit">
          Pateikti pasiÅ«lymÄ…
          <span class="muted2" style="margin-left:8px;">Submit suggestion</span>
        </button>

        <div id="gameStatus" class="status"></div>
      </form>
    </div>
  </div>

  <!-- ADMIN CARD -->
  <div class="card adminOnly" id="adminCard">
    <h2>Organizatorius?</h2>
    <div class="muted2">Organizer?</div>

    <div class="muted" style="margin-top:8px;">
      Admin Ä¯rankiai paslÄ—pti. Ä®junk admin reÅ¾imÄ… atsidarÄ™s puslapÄ¯:
    </div>
    <div class="muted2">
      Admin tools are hidden. Enable admin mode by opening:
    </div>
    <div class="muted" style="margin-top:6px;">
      <code>#admin=YOUR_KEY</code>
    </div>

    <form id="adminForm" style="margin-top:10px;">
      <div class="row">
        <input id="eventDate" type="date" />
        <input id="eventNotes" placeholder="Info / Notes" />
        <button class="btn primary" type="submit">Save</button>
      </div>
    </form>

    <div class="row" style="margin-top:10px;">
      <button id="clearRegsBtn" class="btn danger" type="button">Clear registrations</button>
      <button id="clearGamesBtn" class="btn danger" type="button">Clear games</button>
    </div>

    <div id="adminStatus" class="status"></div>
  </div>

  <!-- Non-admin hint (visible only when admin is OFF) -->
  <div class="card" id="nonAdminHint">
    <div class="muted">Organizatorius?</div>
    <div class="muted2">Organizer?</div>
    <div class="muted2" style="margin-top:6px;">
      Admin Ä¯rankiai paslÄ—pti. Ä®junk admin reÅ¾imÄ… atsidarÄ™s puslapÄ¯:
    </div>
    <div class="muted2">
      Admin tools are hidden. Enable admin mode by opening:
    </div>
    <div class="muted" style="margin-top:6px;">
      <code>#admin=YOUR_KEY</code>
    </div>
  </div>

</div>

<script>
/* ========= Helpers ========= */
const $ = (id) => document.getElementById(id);

function setText(id, text) {
  const el = $(id);
  if (el) el.textContent = text;
}
function setHTML(id, html) {
  const el = $(id);
  if (el) el.innerHTML = html;
}
function escapeHtml(str) {
  return String(str || "").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}
function uid() {
  return "g_" + Math.random().toString(36).slice(2,10) + Date.now().toString(36);
}

/* ========= Admin ========= */
function getAdminToken() {
  const m = location.hash.match(/admin=([^&]+)/);
  return m ? decodeURIComponent(m[1]) : "";
}
function isAdmin() { return !!getAdminToken(); }
function adminHeaders() {
  const t = getAdminToken();
  return t ? { "Authorization": "Bearer " + t } : {};
}

/* ========= API ========= */
async function apiGet(url) {
  const r = await fetch(url);
  const j = await r.json().catch(() => ({}));
  if (!r.ok) throw new Error(j.error || `GET failed (${r.status})`);
  return j;
}
async function apiPost(url, body, headers={}) {
  const r = await fetch(url, {
    method:"POST",
    headers: { "Content-Type":"application/json", ...headers },
    body: JSON.stringify(body)
  });
  const j = await r.json().catch(() => ({}));
  if (!r.ok) throw new Error(j.error || `POST failed (${r.status})`);
  return j;
}
async function apiDelete(url, headers={}) {
  const r = await fetch(url, { method:"DELETE", headers });
  const j = await r.json().catch(() => ({}));
  if (!r.ok) throw new Error(j.error || `DELETE failed (${r.status})`);
  return j;
}

/* ========= State ========= */
const state = { evt:{date:"",notes:""}, regs:[], games:[] };

/* ========= Render ========= */
function renderHeader() {
  const d = state.evt.date || "â€”";
  setText("datePill", d);

  setText("eventLine", `Renginio data: ${d}`);
  setText("eventLineEn", `Event date: ${d}`);

  const notes = (state.evt.notes || "").trim();
  if (notes) {
    setText("notesLine", `Info: ${notes}`);
    setText("notesLineEn", `Info: ${notes}`);
  } else {
    setText("notesLine", "");
    setText("notesLineEn", "");
  }

  if (state.regs.length === 0) {
    setText("whoList", "Kol kas nieko ğŸ™‚");
  } else {
    setText("whoList", state.regs.map(r => r.name).join(", "));
  }
}

function renderAdminVisibility() {
  document.body.classList.toggle("adminOn", isAdmin());
  const adminCard = $("adminCard");
  const nonAdminHint = $("nonAdminHint");
  if (adminCard) adminCard.style.display = isAdmin() ? "block" : "none";
  if (nonAdminHint) nonAdminHint.style.display = isAdmin() ? "none" : "block";

  if (isAdmin()) {
    if ($("eventDate")) $("eventDate").value = state.evt.date || "";
    if ($("eventNotes")) $("eventNotes").value = state.evt.notes || "";
  }
}

function renderGames() {
  const list = $("gameList");
  const jumpBtn = $("jumpSuggestBtn");
  if (jumpBtn) jumpBtn.textContent = `${state.games.length} pasiÅ«lymÅ³`;

  if (!list) return;

  if (!state.games.length) {
    list.innerHTML =
      `<div class="muted" style="margin-top:8px;">Kol kas nÄ—ra pasiÅ«lymÅ³ â€” pridÄ—k savo ğŸ™‚</div>
       <div class="muted2">No suggestions yet â€” add one ğŸ™‚</div>`;
    return;
  }

  list.innerHTML = state.games.map(g => {
    const score = Number(g.score || 0);
    const metaLt = `SudÄ—tingumas: ${g.difficulty} â€¢ VedÄ—jas: ${g.host} â€¢ Å½aidÄ—jai: ${g.players} â€¢ Tipas: ${g.type}`;
    const metaEn = `Complexity: ${g.difficulty} â€¢ Host: ${g.host} â€¢ Players: ${g.players} â€¢ Type: ${g.type}`;

    return `
      <div class="gameItem">
        <div class="gameTop">
          <div style="min-width:240px;flex:1;">
            <div class="gameTitle">${escapeHtml(g.title)}</div>
            <div class="gameMeta">${escapeHtml(metaLt)}</div>
            <div class="gameMeta" style="color:var(--muted2)">${escapeHtml(metaEn)}</div>
          </div>
          <div class="votes">
            <button class="voteBtn" data-id="${escapeHtml(g.id)}" data-delta="1" title="Upvote">â–²</button>
            <span class="score">${score}</span>
            <button class="voteBtn" data-id="${escapeHtml(g.id)}" data-delta="-1" title="Downvote">â–¼</button>
          </div>
        </div>
        ${g.desc ? `<div class="gameDesc">${escapeHtml(g.desc)}</div>` : ""}
      </div>
    `;
  }).join("");

  document.querySelectorAll(".voteBtn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const id = btn.getAttribute("data-id");
      const delta = Number(btn.getAttribute("data-delta"));
      try {
        await apiPost("/api/vote", { id, delta });
        await refreshAll();
      } catch (e) {
        alert(e.message);
      }
    });
  });
}

function renderAll() {
  renderAdminVisibility();
  renderHeader();
  renderGames();
}

/* ========= Load ========= */
async function refreshAll() {
  state.evt = await apiGet("/api/event");
  const regs = await apiGet(`/api/registrations?date=${encodeURIComponent(state.evt.date)}`);
  state.regs = regs.registrations || [];
  const games = await apiGet("/api/suggestions");
  state.games = games.rows || [];
  renderAll();
}

/* ========= UI actions ========= */
$("jumpRegBtn")?.addEventListener("click", () => {
  $("regCard")?.scrollIntoView({ behavior:"smooth", block:"start" });
  $("name")?.focus();
});
$("jumpSuggestBtn")?.addEventListener("click", () => {
  $("suggestCard")?.scrollIntoView({ behavior:"smooth", block:"start" });
  $("gTitle")?.focus();
});

/* ========= Forms ========= */
$("regForm")?.addEventListener("submit", async (e) => {
  e.preventDefault();
  const status = $("regStatus");
  if (status) { status.className="status"; status.textContent=""; }

  const name = ($("name")?.value || "").trim().replace(/\s+/g," ").slice(0,60);
  if (name.length < 2) {
    if (status) { status.className="status warn"; status.textContent="Ä®vesk vardÄ… (min 2 simboliai) / Please enter a name (min 2 characters)"; }
    return;
  }

  try {
    await apiPost("/api/registrations", { date: state.evt.date, name });
    if (status) { status.className="status ok"; status.textContent="UÅ¾siregistruota! / Registered!"; }
    $("regForm").reset();
    await refreshAll();
  } catch (err) {
    const msg = String(err.message || err);
    if (status) { status.className="status warn"; status.textContent=msg; }
  }
});

$("gameForm")?.addEventListener("submit", async (e) => {
  e.preventDefault();
  const status = $("gameStatus");
  if (status) { status.className="status"; status.textContent=""; }

  const title = ($("gTitle")?.value || "").trim();
  const difficulty = Number($("gDifficulty")?.value || 0);
  const host = ($("gHost")?.value || "").trim();
  const players = ($("gPlayers")?.value || "").trim();
  const type = ($("gType")?.value || "").trim();
  const desc = ($("gDesc")?.value || "").trim();

  if (title.length < 2 || !difficulty || !host || !players || !type) {
    if (status) {
      status.className="status warn";
      status.textContent="UÅ¾pildyk visus laukus / Please fill all fields";
    }
    return;
  }

  try {
    await apiPost("/api/suggestions", {
      id: uid(),
      title,
      difficulty,
      host,
      players,
      type,
      desc
    });
    if (status) { status.className="status ok"; status.textContent="PasiÅ«lymas pateiktas / Suggestion submitted"; }
    $("gameForm").reset();
    await refreshAll();
  } catch (err) {
    if (status) { status.className="status warn"; status.textContent=String(err.message || err); }
  }
});

/* ========= Admin ========= */
$("adminForm")?.addEventListener("submit", async (e) => {
  e.preventDefault();
  const status = $("adminStatus");
  if (status) { status.className="status"; status.textContent=""; }

  try {
    await apiPost("/api/admin/event", {
      date: $("eventDate")?.value,
      notes: $("eventNotes")?.value || ""
    }, adminHeaders());
    if (status) { status.className="status ok"; status.textContent="Saved"; }
    await refreshAll();
  } catch (err) {
    if (status) { status.className="status warn"; status.textContent=String(err.message || err); }
  }
});

$("clearRegsBtn")?.addEventListener("click", async () => {
  const status = $("adminStatus");
  if (status) { status.className="status"; status.textContent=""; }
  try {
    await apiDelete(`/api/registrations?date=${encodeURIComponent(state.evt.date)}`, adminHeaders());
    if (status) { status.className="status ok"; status.textContent="Registrations cleared"; }
    await refreshAll();
  } catch (err) {
    if (status) { status.className="status warn"; status.textContent=String(err.message || err); }
  }
});

$("clearGamesBtn")?.addEventListener("click", async () => {
  const status = $("adminStatus");
  if (status) { status.className="status"; status.textContent=""; }
  try {
    await apiDelete("/api/suggestions", adminHeaders());
    if (status) { status.className="status ok"; status.textContent="Games cleared"; }
    await refreshAll();
  } catch (err) {
    if (status) { status.className="status warn"; status.textContent=String(err.message || err); }
  }
});

/* ========= Boot ========= */
window.addEventListener("hashchange", () => renderAdminVisibility());
refreshAll().catch(e => alert("Backend error: " + e.message));
</script>
</body>
</html>
