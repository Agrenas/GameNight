<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Game Night Registration</title>
  <style>
    :root{
      --bg:#071733; --card:rgba(255,255,255,.06); --border:rgba(255,255,255,.14);
      --text:#eaf1ff; --muted:rgba(234,241,255,.78);
      --ok:#68ffb3; --warn:#ffd36b; --bad:#ff6b6b;
    }
    body{margin:0;font-family:system-ui,Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--text);}
    .wrap{max-width:980px;margin:0 auto;padding:20px;}
    .header{
      border:1px solid var(--border); background:var(--card); border-radius:18px;
      padding:16px 16px 14px; margin-bottom:14px;
    }
    h1{margin:0 0 6px;font-size:20px;}
    h2{margin:0 0 10px;font-size:16px;}
    .muted{color:var(--muted); font-size:13px; margin:0;}
    .row{display:grid; grid-template-columns: 1fr; gap:14px;}
    @media(min-width: 920px){ .row{grid-template-columns: 1.05fr .95fr;} }

    .card{border:1px solid var(--border); background:var(--card); border-radius:18px; padding:16px;}
    label{display:block;margin:10px 0 6px;font-weight:650;}
    input, textarea, select{
      width:100%; box-sizing:border-box; padding:10px 12px;
      border:1px solid rgba(255,255,255,.18);
      border-radius:12px; background:rgba(0,0,0,.20); color:var(--text);
      font-size:15px;
    }
    textarea{min-height:90px; resize:vertical;}
    button{
      margin-top:12px; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.10); color:var(--text); cursor:pointer; font-weight:650;
    }
    button:hover{background:rgba(255,255,255,.14);}
    .pill{
      display:inline-block; padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.18); background:rgba(0,0,0,.15); font-size:12px;
      margin-right:8px;
    }
    .status{margin-top:10px; font-weight:650;}
    .status.ok{color:var(--ok);}
    .status.warn{color:var(--warn);}
    .status.bad{color:var(--bad);}
    ul{margin:10px 0 0 18px; padding:0;}
    li{margin:6px 0;}
    .tiny{font-size:12px; color:var(--muted); margin-top:10px;}
    .adminBadge{display:none;}
    .adminOn .adminBadge{display:inline-block;}
    .adminOnly{display:none;}
    .adminOn .adminOnly{display:block;}
    .danger{background:rgba(255,107,107,.10); border-color:rgba(255,107,107,.25);}

    /* Game list */
    .gameItem{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.16);
      border-radius:14px;
      padding:12px;
      margin-top:10px;
    }
    .gameTop{
      display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:flex-start;
    }
    .gameTitle{font-weight:800; font-size:16px; margin:0;}
    .gameMeta{margin:6px 0 0; color:var(--muted); font-size:13px; line-height:1.35;}
    .voteBox{display:flex; align-items:center; gap:8px;}
    .voteBtn{
      margin:0;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.08);
      cursor:pointer;
      font-weight:800;
    }
    .voteBtn:hover{background:rgba(255,255,255,.12);}
    .score{
      min-width:48px;
      text-align:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.12);
      font-weight:800;
    }
    .gameDesc{margin:10px 0 0; font-size:14px; color:rgba(234,241,255,.92);}
    .grid2{display:grid; grid-template-columns: 1fr; gap:10px;}
    @media(min-width:680px){ .grid2{grid-template-columns: 1fr 1fr;} }
  </style>
</head>
<body>
  <div class="wrap">

    <!-- HEADER 1: Event -->
    <div id="topHeader" class="header">
      <div style="display:flex; justify-content:space-between; gap:12px; align-items:flex-start; flex-wrap:wrap;">
        <div>
          <h1>
            Game Night Registration
            <span class="pill adminBadge">ADMIN</span>
          </h1>
          <p class="muted" id="eventLine">Loading event‚Ä¶</p>
          <p class="muted" id="notesLine"></p>
        </div>
        <div>
          <span class="pill" id="countPill">0 registered</span>
          <span class="pill" id="datePill">‚Äî</span>
        </div>
      </div>

      <div id="whoBlock" style="margin-top:10px;">
        <p class="muted" style="margin:0 0 6px;">Registered:</p>
        <div id="whoList" class="muted">‚Äî</div>
      </div>

      <div class="tiny">Participation optional, registration required.</div>
    </div>

    <!-- HEADER 2: Game suggestions + voting -->
    <div id="gamesHeader" class="header">
      <div style="display:flex; justify-content:space-between; gap:12px; align-items:flex-start; flex-wrap:wrap;">
        <div>
          <h1 style="margin-bottom:6px;">Board Game Suggestions & Voting</h1>
          <p class="muted">
            Suggest a game and vote for what we should play. (No login.)
          </p>
        </div>
        <div>
          <span class="pill" id="gameCountPill">0 suggestions</span>
          <span class="pill" id="sortPill">sorted by score</span>
        </div>
      </div>

      <div id="gameList"></div>

      <div class="tiny">
        Tip: keep suggestions short & helpful. Votes are stored per-device in this version.
      </div>
    </div>

    <div class="row">

      <!-- Participant registration -->
      <div class="card">
        <h2>Register</h2>
        <form id="regForm">
          <label for="name">Your name</label>
          <input id="name" name="name" type="text" minlength="2" maxlength="60" placeholder="e.g., Audrius" required />
          <button type="submit">Register for this date</button>
        </form>
        <div id="regStatus" class="status" aria-live="polite"></div>
        <div class="tiny">You‚Äôre registering for the date shown above.</div>
      </div>

      <!-- Suggest a board game -->
      <div class="card">
        <h2>Suggest a Board Game</h2>
        <form id="gameForm">
          <label for="gTitle">≈Ωaidimo pavadinimas</label>
          <input id="gTitle" name="gTitle" type="text" minlength="2" maxlength="80" placeholder="Pvz., Codenames" required />

          <div class="grid2">
            <div>
              <label for="gDifficulty">Sudƒótingumas</label>
              <select id="gDifficulty" name="gDifficulty" required>
                <option value="">Pasirinkti‚Ä¶</option>
                <option value="1">1 (lengvas)</option>
                <option value="2">2 (vidutinis)</option>
                <option value="3">3 (sunkesnis)</option>
              </select>
            </div>
            <div>
              <label for="gHost">Reikalingas vedƒójas?</label>
              <select id="gHost" name="gHost" required>
                <option value="">Pasirinkti‚Ä¶</option>
                <option value="no">Ne</option>
                <option value="yes">Taip</option>
              </select>
            </div>
          </div>

          <div class="grid2">
            <div>
              <label for="gPlayers">≈Ωaidƒój≈≥ skaiƒçius</label>
              <input id="gPlayers" name="gPlayers" type="text" maxlength="20" placeholder="Pvz., 2‚Äì6" required />
            </div>
            <div>
              <label for="gType">≈Ωaidimo tipas</label>
              <select id="gType" name="gType" required>
                <option value="">Pasirinkti‚Ä¶</option>
                <option value="coop">Co-op</option>
                <option value="comp">Competitive</option>
              </select>
            </div>
          </div>

          <label for="gDesc">Trumpas apra≈°ymas</label>
          <textarea id="gDesc" name="gDesc" maxlength="280" placeholder="1‚Äì2 sakiniai: kuo smagus, kiek trunka, ar lengva i≈°mokti‚Ä¶" required></textarea>

          <button type="submit">Pateikti pasi≈´lymƒÖ</button>
        </form>
        <div id="gameStatus" class="status" aria-live="polite"></div>
        <div class="tiny">This will appear above with voting.</div>
      </div>

      <!-- Admin panel -->
      <div class="card adminOnly" id="adminCard">
        <h2>Admin: Create / Update Event</h2>
        <form id="adminForm">
          <label for="eventDate">Event date (YYYY-MM-DD)</label>
          <input id="eventDate" name="eventDate" type="date" required />
          <label for="eventNotes">Notes (optional)</label>
          <textarea id="eventNotes" name="eventNotes" placeholder="e.g., Thursday, starts 17:00, bring game ideas‚Ä¶"></textarea>
          <button type="submit">Save event</button>
        </form>

        <button class="danger" id="clearRegsBtn" type="button" title="Clears registrations for current event">
          Clear registrations for this event
        </button>

        <button class="danger" id="clearGamesBtn" type="button" title="Clears game suggestions">
          Clear all game suggestions (this device)
        </button>

        <div id="adminStatus" class="status" aria-live="polite"></div>
        <div class="tiny">
          Admin mode is enabled via URL hash: <code>#admin=YOUR_KEY</code>
        </div>
      </div>

      <!-- Non-admin hint -->
      <div class="card" id="nonAdminHint">
        <h2>Organizer?</h2>
        <p class="muted" style="margin:0;">
          Admin tools are hidden. To enable admin mode, open the page with:
          <br><code>#admin=YOUR_KEY</code>
        </p>
        <p class="tiny" style="margin:10px 0 0;">
          (Replace YOUR_KEY with your secret key in the script.)
        </p>
      </div>

    </div>
  </div>

<script>
const $ = (id) => document.getElementById(id);

// -------- Admin token from URL hash --------
// Use: https://site/#admin=YOUR_TOKEN
function getAdminToken() {
  const hash = window.location.hash || "";
  const m = hash.match(/admin=([^&]+)/);
  if (!m) return "";
  try { return decodeURIComponent(m[1]); } catch { return ""; }
}
function isAdmin() { return !!getAdminToken(); }
function adminHeaders() {
  const t = getAdminToken();
  return t ? { "Authorization": "Bearer " + t } : {};
}

// -------- Helpers (keep your existing behavior) --------
function sanitizeName(name) {
  return String(name || "").trim().replace(/\s+/g, " ").slice(0, 60);
}
function uid() {
  return "g_" + Math.random().toString(36).slice(2, 10) + Date.now().toString(36);
}
function normalizeTitle(s) {
  return String(s || "").trim().replace(/\s+/g, " ").slice(0, 120);
}
function escapeHtml(str) {
  return String(str || "").replace(/[&<>"']/g, (m) => ({
    "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
  }[m]));
}
function metaText(g) {
  const diff = Number(g.difficulty);
  const diffText = diff === 1 ? "Lengvas" : diff === 2 ? "Vidutinis" : "Sunkesnis";
  const diffTextEn = diff === 1 ? "Easy" : diff === 2 ? "Medium" : "Harder";
  return `${diffText} ‚Ä¢ Vedƒójas: ${g.host} ‚Ä¢ ≈Ωaidƒójai: ${g.players} ‚Ä¢ Tipas: ${g.type}
    ‚Äî ${diffTextEn} ‚Ä¢ Host: ${g.host} ‚Ä¢ Players: ${g.players} ‚Ä¢ Type: ${g.type}`;
}

// -------- API helpers --------
async function apiGet(path) {
  const res = await fetch(path);
  const data = await res.json().catch(() => ({}));
  if (!res.ok) throw new Error(data.error || `GET failed (${res.status})`);
  return data;
}
async function apiPost(path, body, headers = {}) {
  const res = await fetch(path, {
    method: "POST",
    headers: { "Content-Type": "application/json", ...headers },
    body: JSON.stringify(body),
  });
  const data = await res.json().catch(() => ({}));
  if (!res.ok) throw new Error(data.error || `POST failed (${res.status})`);
  return data;
}
async function apiDelete(path, headers = {}) {
  const res = await fetch(path, { method: "DELETE", headers });
  const data = await res.json().catch(() => ({}));
  if (!res.ok) throw new Error(data.error || `DELETE failed (${res.status})`);
  return data;
}

// -------- In-memory state (no localStorage) --------
const state = {
  evt: { date: "2026-01-16", notes: "" },
  regs: [],
  games: []
};

// -------- Load everything from backend --------
async function refreshAll() {
  state.evt = await apiGet("/api/event");

  const regData = await apiGet(`/api/registrations?date=${encodeURIComponent(state.evt.date)}`);
  state.regs = regData.registrations || [];

  const sugData = await apiGet("/api/suggestions");
  state.games = sugData.rows || [];

  render();
}

// -------- Render games --------
function renderGames() {
  const games = state.games || [];
  if (games.length === 0) {
    $("gameList").innerHTML = `<p class="muted" style="margin-top:10px;">
      Kol kas nƒóra pasi≈´lym≈≥ ‚Äî pridƒók savo üôÇ<span class="suben">No suggestions yet ‚Äî add one üôÇ</span>
    </p>`;
    return;
  }

  $("gameList").innerHTML = games.map(g => {
    const score = Number(g.score || 0);
    return `
      <div class="gameItem">
        <div class="gameTop">
          <div style="min-width:240px; flex:1;">
            <p class="gameTitle">${escapeHtml(g.title)}</p>
            <p class="gameMeta">${escapeHtml(metaText(g))}</p>
          </div>

          <div class="votes">
            <button class="voteBtn" data-id="${escapeHtml(g.id)}" data-delta="1">‚ñ≤</button>
            <span class="score">${score}</span>
            <button class="voteBtn" data-id="${escapeHtml(g.id)}" data-delta="-1">‚ñº</button>
          </div>
        </div>

        ${g.desc ? `<div class="gameDesc">${escapeHtml(g.desc)}</div>` : ""}
      </div>
    `;
  }).join("");

  document.querySelectorAll(".voteBtn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const id = btn.getAttribute("data-id");
      const delta = Number(btn.getAttribute("data-delta")) || 0;
      try {
        await apiPost("/api/vote", { id, delta });
        await refreshAll();
      } catch (e) {
        alert(e.message);
      }
    });
  });
}

// -------- Render all --------
function render() {
  const admin = isAdmin();
  document.body.classList.toggle("adminOn", admin);

  $("adminCard").style.display = admin ? "block" : "none";
  $("nonAdminHint").style.display = admin ? "none" : "block";

  const evt = state.evt;
  const regs = state.regs || [];

  // These IDs exist in your HTML already
  $("eventLine").firstChild.textContent = `Renginio data: ${evt.date}`;
  $("eventLineEn").textContent = `Event date: ${evt.date}`;
  $("datePill").textContent = evt.date;

  const notes = (evt.notes || "").trim();
  $("notesLine").textContent = "";
  if (notes) $("notesLine").innerHTML = `Info: ${escapeHtml(notes)}<span class="suben">Info: ${escapeHtml(notes)}</span>`;

  $("countPill").textContent = `${regs.length} u≈æsiregistravo`;

  if (regs.length === 0) $("whoList").textContent = "Kol kas nieko üôÇ";
  else $("whoList").textContent = regs.map(r => r.name).join(", ");

  if (admin) {
    $("eventDate").value = evt.date;
    $("eventNotes").value = evt.notes || "";
  }

  renderGames();
}

// -------- Registration submit --------
$("regForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const name = sanitizeName($("name").value);
  const status = $("regStatus");
  status.textContent = "";
  status.className = "status";

  if (name.length < 2) {
    status.innerHTML = `ƒÆvesk vardƒÖ (min 2 simboliai).<span class="suben">Please enter your name (min 2 characters).</span>`;
    status.classList.add("warn");
    return;
  }

  try {
    await apiPost("/api/registrations", { date: state.evt.date, name });
    status.innerHTML = `U≈æsiregistruota! Iki pasimatymo üôÇ<span class="suben">Registered! See you üôÇ</span>`;
    status.classList.add("ok");
    $("regForm").reset();
    $("name").focus();
    await refreshAll();
  } catch (err) {
    if ((err.message || "").includes("already_registered")) {
      status.innerHTML = `Jau esi u≈æsiregistravƒôs ≈°iai datai.<span class="suben">You're already registered for this date.</span>`;
      status.classList.add("warn");
      return;
    }
    status.textContent = err.message;
    status.classList.add("warn");
  }
});

// -------- Suggest a game --------
$("gameForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const status = $("gameStatus");
  status.textContent = "";
  status.className = "status";

  const title = normalizeTitle($("gTitle").value);
  const difficulty = $("gDifficulty").value;
  const host = $("gHost").value;
  const players = normalizeTitle($("gPlayers").value);
  const type = $("gType").value;
  const desc = normalizeTitle($("gDesc").value);

  if (title.length < 2) {
    status.innerHTML = `ƒÆra≈°yk ≈æaidimo pavadinimƒÖ.<span class="suben">Please enter a game title.</span>`;
    status.classList.add("warn");
    return;
  }
  if (!difficulty || !host || !type) {
    status.innerHTML = `U≈æpildyk sudƒótingumƒÖ, vedƒójƒÖ ir tipƒÖ.<span class="suben">Please fill complexity, host and type.</span>`;
    status.classList.add("warn");
    return;
  }
  if (players.length < 1) {
    status.innerHTML = `ƒÆra≈°yk ≈æaidƒój≈≥ skaiƒçi≈≥ (pvz. 2‚Äì4).<span class="suben">Please enter player count (e.g. 2‚Äì4).</span>`;
    status.classList.add("warn");
    return;
  }

  try {
    await apiPost("/api/suggestions", {
      id: uid(),
      title,
      difficulty: Number(difficulty),
      host,
      players,
      type,
      desc
    });

    status.innerHTML = `Aƒçi≈´! Pasi≈´lymas pridƒótas.<span class="suben">Thanks! Suggestion added.</span>`;
    status.classList.add("ok");
    $("gameForm").reset();
    $("gTitle").focus();
    await refreshAll();
  } catch (err) {
    status.textContent = err.message;
    status.classList.add("warn");
  }
});

// -------- Admin: save event --------
$("adminForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const status = $("adminStatus");
  status.textContent = "";
  status.className = "status";

  if (!isAdmin()) {
    status.innerHTML = `Admin re≈æimas neƒØjungtas.<span class="suben">Admin mode not enabled.</span>`;
    status.classList.add("warn");
    return;
  }

  const date = $("eventDate").value;
  const notes = ($("eventNotes").value || "").trim();

  try {
    await apiPost("/api/admin/event", { date, notes }, adminHeaders());
    status.innerHTML = `I≈°saugota: ${escapeHtml(date)}<span class="suben">Saved: ${escapeHtml(date)}</span>`;
    status.classList.add("ok");
    await refreshAll();
  } catch (err) {
    status.textContent = err.message;
    status.classList.add("warn");
  }
});

// -------- Admin: clear regs / games --------
$("clearRegsBtn").addEventListener("click", async () => {
  const status = $("adminStatus");
  status.textContent = "";
  status.className = "status";

  try {
    await apiDelete(`/api/registrations?date=${encodeURIComponent(state.evt.date)}`, adminHeaders());
    status.innerHTML = `I≈°valytos registracijos: ${escapeHtml(state.evt.date)}<span class="suben">Cleared registrations: ${escapeHtml(state.evt.date)}</span>`;
    status.classList.add("ok");
    await refreshAll();
  } catch (err) {
    status.textContent = err.message;
    status.classList.add("warn");
  }
});

$("clearGamesBtn").addEventListener("click", async () => {
  const status = $("adminStatus");
  status.textContent = "";
  status.className = "status";

  try {
    await apiDelete("/api/suggestions", adminHeaders());
    status.innerHTML = `I≈°valyti ≈æaidimai.<span class="suben">Games cleared.</span>`;
    status.classList.add("ok");
    await refreshAll();
  } catch (err) {
    status.textContent = err.message;
    status.classList.add("warn");
  }
});

// Boot
window.addEventListener("hashchange", () => render());
refreshAll().catch((e) => {
  console.error(e);
  alert("Backend error: " + e.message);
});
</script>

</body>
</html>
