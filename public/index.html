<!DOCTYPE html>
<html lang="lt">
<head>
  <meta charset="utf-8" />
  <title>Game Night Registration</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg: #0b1324;
      --card: #121b33;
      --muted: #9aa3b2;
      --text: #e7ecf3;
      --accent: #4ea1ff;
      --ok: #4caf50;
      --warn: #ff9800;
      --danger: #ff5252;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: linear-gradient(180deg, #0b1324, #0e1730);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 24px;
    }

    .wrap {
      width: 100%;
      max-width: 760px;
    }

    h1 {
      margin: 0 0 8px;
      font-size: 28px;
    }

    .sub {
      color: var(--muted);
      margin-bottom: 20px;
    }

    .card {
      background: var(--card);
      border-radius: 14px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,.35);
    }

    .muted {
      color: var(--muted);
      font-size: 14px;
    }

    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    input, select, button, textarea {
      background: #0e1730;
      color: var(--text);
      border: 1px solid #1c2750;
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 14px;
    }

    input, select, textarea {
      flex: 1;
      min-width: 200px;
    }

    button {
      cursor: pointer;
      border-color: var(--accent);
    }

    button.primary {
      background: var(--accent);
      color: #001a3a;
      font-weight: 600;
    }

    button.danger {
      border-color: var(--danger);
      color: var(--danger);
    }

    .status {
      margin-top: 10px;
      font-size: 14px;
    }
    .status.ok { color: var(--ok); }
    .status.warn { color: var(--warn); }

    .pill {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      background: #1b264f;
      font-size: 12px;
      margin-left: 6px;
    }

    .gameItem {
      border-top: 1px solid #1c2750;
      padding-top: 12px;
      margin-top: 12px;
    }

    .gameTop {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
    }

    .gameTitle {
      font-weight: 600;
    }

    .gameMeta {
      font-size: 13px;
      color: var(--muted);
    }

    .votes {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .voteBtn {
      background: none;
      border: 1px solid #1c2750;
      width: 28px;
      height: 28px;
      border-radius: 6px;
      color: var(--text);
      cursor: pointer;
    }

    .adminOn .adminOnly { display: block; }
    .adminOnly { display: none; }
  </style>
</head>

<body>
<div class="wrap">

  <h1>Game Night Registration</h1>
  <div class="sub">
    Internal team-building event · Stalo žaidimų vakaras
  </div>

  <!-- EVENT INFO -->
  <div class="card">
    <div id="eventLine">Renginio data: —</div>
    <div id="eventLineEn" class="muted">Event date: —</div>

    <div id="notesLine" class="muted" style="margin-top:6px;"></div>

    <div style="margin-top:12px;">
      <span id="countPill" class="pill">0 užsiregistravo</span>
    </div>

    <div class="muted" style="margin-top:10px;">
      Registered:
      <span id="whoList">—</span>
    </div>

    <div class="muted" style="margin-top:10px;">
      Participation optional, registration required.<br/>
      Dalyvavimas nebūtinas, bet reikalinga registracija.
    </div>
  </div>

  <!-- REGISTRATION -->
  <div class="card">
    <h3>Registracija / Registration</h3>

    <form id="regForm">
      <div class="row">
        <input id="name" placeholder="Vardas / Name" required />
        <button class="primary" type="submit">Register</button>
      </div>
    </form>

    <div id="regStatus" class="status"></div>
  </div>

  <!-- GAME SUGGESTIONS -->
  <div class="card">
    <h3>Žaidimų pasiūlymai / Game suggestions</h3>

    <form id="gameForm">
      <div class="row">
        <input id="gTitle" placeholder="Žaidimo pavadinimas / Game title" />
        <select id="gDifficulty">
          <option value="">Sudėtingumas / Difficulty</option>
          <option value="1">Lengvas / Easy</option>
          <option value="2">Vidutinis / Medium</option>
          <option value="3">Sunkesnis / Harder</option>
        </select>
      </div>

      <div class="row" style="margin-top:10px;">
        <input id="gHost" placeholder="Vedėjas / Host" />
        <input id="gPlayers" placeholder="Žaidėjai (pvz. 2–4)" />
        <select id="gType">
          <option value="">Tipas / Type</option>
          <option value="Party">Party</option>
          <option value="Strategy">Strategy</option>
          <option value="Co-op">Co-op</option>
        </select>
      </div>

      <div class="row" style="margin-top:10px;">
        <textarea id="gDesc" placeholder="Pastabos / Notes (nebūtina)" rows="2"></textarea>
      </div>

      <button class="primary" style="margin-top:10px;" type="submit">
        Add suggestion
      </button>
    </form>

    <div id="gameStatus" class="status"></div>

    <div id="gameList"></div>
  </div>

  <!-- ADMIN -->
  <div class="card adminOnly">
    <h3>Admin</h3>

    <form id="adminForm">
      <div class="row">
        <input id="eventDate" type="date" />
        <input id="eventNotes" placeholder="Info / Notes" />
        <button class="primary" type="submit">Save</button>
      </div>
    </form>

    <div class="row" style="margin-top:10px;">
      <button id="clearRegsBtn" class="danger">Clear registrations</button>
      <button id="clearGamesBtn" class="danger">Clear games</button>
    </div>

    <div id="adminStatus" class="status"></div>
  </div>

</div>

<script>
/* =======================
   SAFE HELPERS
======================= */
const $ = (id) => document.getElementById(id);

function setText(id, text) {
  const el = $(id);
  if (el) el.textContent = text;
}

function setHTML(id, html) {
  const el = $(id);
  if (el) el.innerHTML = html;
}

function uid() {
  return "g_" + Math.random().toString(36).slice(2) + Date.now().toString(36);
}

/* =======================
   ADMIN
======================= */
function getAdminToken() {
  const m = location.hash.match(/admin=([^&]+)/);
  return m ? decodeURIComponent(m[1]) : "";
}
function isAdmin() {
  return !!getAdminToken();
}
function adminHeaders() {
  const t = getAdminToken();
  return t ? { "Authorization": "Bearer " + t } : {};
}

/* =======================
   API
======================= */
async function apiGet(url) {
  const r = await fetch(url);
  const j = await r.json().catch(() => ({}));
  if (!r.ok) throw new Error(j.error || "GET failed");
  return j;
}
async function apiPost(url, body, headers = {}) {
  const r = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json", ...headers },
    body: JSON.stringify(body),
  });
  const j = await r.json().catch(() => ({}));
  if (!r.ok) throw new Error(j.error || "POST failed");
  return j;
}
async function apiDelete(url, headers = {}) {
  const r = await fetch(url, { method: "DELETE", headers });
  const j = await r.json().catch(() => ({}));
  if (!r.ok) throw new Error(j.error || "DELETE failed");
  return j;
}

/* =======================
   STATE
======================= */
const state = { evt: {}, regs: [], games: [] };

/* =======================
   RENDER
======================= */
function render() {
  document.body.classList.toggle("adminOn", isAdmin());

  setText("eventLine", `Renginio data: ${state.evt.date || "—"}`);
  setText("eventLineEn", `Event date: ${state.evt.date || "—"}`);

  setHTML("notesLine", state.evt.notes ? state.evt.notes : "");

  setText("countPill", `${state.regs.length} užsiregistravo`);
  setText("whoList", state.regs.length ? state.regs.map(r => r.name).join(", ") : "—");

  if (isAdmin()) {
    if ($("eventDate")) $("eventDate").value = state.evt.date || "";
    if ($("eventNotes")) $("eventNotes").value = state.evt.notes || "";
  }

  renderGames();
}

function renderGames() {
  const list = $("gameList");
  if (!list) return;

  if (!state.games.length) {
    list.innerHTML = `<div class="muted">Kol kas nėra pasiūlymų.</div>`;
    return;
  }

  list.innerHTML = state.games.map(g => `
    <div class="gameItem">
      <div class="gameTop">
        <div>
          <div class="gameTitle">${g.title}</div>
          <div class="gameMeta">
            ${g.host} · ${g.players} · ${g.type}
          </div>
        </div>
        <div class="votes">
          <button class="voteBtn" data-id="${g.id}" data-delta="1">▲</button>
          <span>${g.score}</span>
          <button class="voteBtn" data-id="${g.id}" data-delta="-1">▼</button>
        </div>
      </div>
      ${g.desc ? `<div class="muted">${g.desc}</div>` : ""}
    </div>
  `).join("");

  document.querySelectorAll(".voteBtn").forEach(b => {
    b.onclick = async () => {
      await apiPost("/api/vote", {
        id: b.dataset.id,
        delta: Number(b.dataset.delta)
      });
      await refreshAll();
    };
  });
}

/* =======================
   LOAD
======================= */
async function refreshAll() {
  state.evt = await apiGet("/api/event");
  const r = await apiGet(`/api/registrations?date=${state.evt.date}`);
  state.regs = r.registrations || [];
  const g = await apiGet("/api/suggestions");
  state.games = g.rows || [];
  render();
}

/* =======================
   EVENTS
======================= */
$("regForm").onsubmit = async (e) => {
  e.preventDefault();
  try {
    await apiPost("/api/registrations", {
      date: state.evt.date,
      name: $("name").value.trim()
    });
    setText("regStatus", "Registered!");
    await refreshAll();
  } catch (e) {
    setText("regStatus", e.message);
  }
};

$("gameForm").onsubmit = async (e) => {
  e.preventDefault();
  try {
    await apiPost("/api/suggestions", {
      id: uid(),
      title: $("gTitle").value,
      difficulty: Number($("gDifficulty").value),
      host: $("gHost").value,
      players: $("gPlayers").value,
      type: $("gType").value,
      desc: $("gDesc").value
    });
    setText("gameStatus", "Added!");
    await refreshAll();
  } catch (e) {
    setText("gameStatus", e.message);
  }
};

$("adminForm").onsubmit = async (e) => {
  e.preventDefault();
  try {
    await apiPost("/api/admin/event", {
      date: $("eventDate").value,
      notes: $("eventNotes").value
    }, adminHeaders());
    setText("adminStatus", "Saved");
    await refreshAll();
  } catch (e) {
    setText("adminStatus", e.message);
  }
};

$("clearRegsBtn").onclick = async () => {
  await apiDelete(`/api/registrations?date=${state.evt.date}`, adminHeaders());
  await refreshAll();
};

$("clearGamesBtn").onclick = async () => {
  await apiDelete("/api/suggestions", adminHeaders());
  await refreshAll();
};

refreshAll();
</script>
</body>
</html>
